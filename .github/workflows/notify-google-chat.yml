name: Notify Google Chat for Renovate PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # A√±adido para ejecuci√≥n manual

jobs:
  notify-google-chat:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Debug Workflow Trigger
        run: |
          echo "Event Name: $GITHUB_EVENT_NAME"
          echo "Actor: $GITHUB_ACTOR"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Event Path Content: $(cat $GITHUB_EVENT_PATH || echo 'File not found')"
      - name: Send Google Chat Notification
        if: github.actor == 'renovate[bot]' || github.actor == 'renovate-bot' || github.actor == 'Jocasmen94'
        env:
          GOOGLE_CHAT_WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
        run: |
          PR_TITLE=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH" || echo "null")
          PR_URL=$(jq -r .pull_request.html_url "$GITHUB_EVENT_PATH" || echo "null")
          PR_AUTHOR=$(jq -r .pull_request.user.login "$GITHUB_EVENT_PATH" || echo "null")
          PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH" || echo "null")
          PR_CREATED_AT=$(jq -r .pull_request.created_at "$GITHUB_EVENT_PATH" | awk -F'T' '{print $1}' || echo "null")
          MESSAGE=$(cat <<EOF
          {
            "text": "üîî *New Renovate PR*\n**Title:** $PR_TITLE\n**URL:** $PR_URL\n**Author:** $PR_AUTHOR\n**Number:** $PR_NUMBER\n**Created:** $PR_CREATED_AT"
          }
          EOF
          )
          curl -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$GOOGLE_CHAT_WEBHOOK_URL"