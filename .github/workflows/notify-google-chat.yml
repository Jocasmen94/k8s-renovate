name: Notify Google Chat for Renovate PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # A침adido para ejecuci칩n manual

jobs:
  notify-google-chat:
    runs-on: ubuntu-latest
    # Condici칩n m칤nima para depuraci칩n
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Debug Workflow Trigger
        run: |
          echo "Event Name: $GITHUB_EVENT_NAME"
          echo "Actor: $GITHUB_ACTOR"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Ref: $GITHUB_REF"
          echo "Event Path Content: $(cat $GITHUB_EVENT_PATH || echo 'File not found')"
      - name: Send Google Chat Notification
        if: github.actor == 'renovate[bot]' || github.actor == 'renovate-bot' || github.actor == 'Jocasmen94'
        env:
          GOOGLE_CHAT_WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
        run: |
          PR_TITLE=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH")
          PR_URL=$(jq -r .pull_request.html_url "$GITHUB_EVENT_PATH")
          PR_AUTHOR=$(jq -r .pull_request.user.login "$GITHUB_EVENT_PATH")
          PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
          PR_CREATED_AT=$(jq -r .pull_request.created_at "$GITHUB_EVENT_PATH" | awk -F'T' '{print $1}')
          MESSAGE=$(cat <<EOF
          {
            "text": "游댒 *New Renovate PR*\n**Title:** $PR_TITLE\n**URL:** $PR_URL\n**Author:** $PR_AUTHOR\n**Number:** $PR_NUMBER\n**Created:** $PR_CREATED_AT"
          }
          EOF
          )
          curl -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$GOOGLE_CHAT_WEBHOOK_URL"